#!/bin/bash

###
# Init script for this project. Creates initial project configuration
###


## VARIABLES

interact="true" # Enable interactive mode

# List of services
enable_service_panel=""
enable_service_node=""
enable_service_db=""
enable_service_le=""
enable_sftp_daemon=""

enable_build_options=""

# Daemon Options
node_directory=""
node_docker_socket=""
node_docker_root=""

#Database Options
database_ip_address=""
database_root_password=""

# Functions

# Returns the help message
function _return_help {
	echo ""
	echo "Pterodactyl Docker Deployment Script"
	echo "Usage: $0 [options]"
	echo ""
	echo "Options:"
	echo ""
	echo " --help  , -h             - returns this screen"
    echo " --enable-panel           - adds panel"
    echo " --enable-db              - adds mysql database"
    echo " --enable-daemon          - adds daemon"
    echo " --enable-letsencrypt     - adds letsencrypt"
    echo " --enable-build-options"
    echo " --db-address"
    echo " --daemon-dir"
	echo ""
}

function build_config {
    local combine_args=""

    # Panel
    if [ "$enable_service_panel" == "x" ]; then
        combine_args="./manifest/compose/panel.yml"

        # Enable Build Options
        if [ "$enable_build_options" == "x" ]; then
            combine_args=$combine_args" ./manifest/compose/build.panel.yml"

            if grep -q "PANEL_VERSION=" .env; then
                sed -i "s/PANEL_VERSION=.*/$(grep "PANEL_VERSION=" manifest/version.txt)/" .env
            else
                grep "PANEL_VERSION=" manifest/version.txt >> .env
            fi
        fi

        # Enable Panel Let's Encrypt Option
        if [ "$enable_service_le" == "x" ]; then
            combine_args=$combine_args" ./manifest/compose/le.panel.yml"
        fi

    fi

    # Daemon
    if [ "$enable_service_node" == "x" ]; then
        combine_args=$combine_args" ./manifest/compose/daemon.yml"

        # Enable Build Options
        if [ "$enable_build_options" == "x" ]; then
            combine_args=$combine_args" ./manifest/compose/build.daemon.yml"

            # Checks if variables exist within .env
            if grep -q "DAEMON_VERSION=" .env; then
                sed -i "s/DAEMON_VERSION=.*/$(grep "DAEMON_VERSION=" manifest/version.txt)/" .env
            else
                grep "DAEMON_VERSION=" manifest/version.txt >> .env
            fi
        fi

        # Enable Daemon Let's Encrypt Option If Panel is not used
        if [ "$enable_service_le" == "x" ] && [ "$enable_service_panel" == "" ]; then
            combine_args=$combine_args" ./manifest/compose/le.daemon.yml"
        fi
    fi

    # Database
    if [ "$enable_service_db" == "x" ]; then
        combine_args=$combine_args" ./manifest/compose/db.yml"
    fi

    if [ "$combine_args" == "" ]; then
        echo "no args have been passed, exiting..."
        exit
    fi

    IFS=" "
    config="$(bin/yq merge -a -x ${combine_args} | bin/yq read --stripComments -)"

    # Modifiers
    if [ ! "$node_directory" == "" ] && [ "$enable_service_node" == "x" ]; then
        config=$(echo "$config" | bin/yq write - "services.daemon.volumes[0]" "$node_directory:$node_directory")
        config=$(echo "$config" | bin/yq write - "services.daemon.working_dir" "$node_directory")
    fi

    if [ ! "$database_ip_address" == "" ] && [ "$enable_service_db" == "x" ]; then
        config=$(echo "$config" | bin/yq write -i docker-compose.yml "services.mysql.ports[0]" "$database_ip_address:3306")
    fi

    if ! [ -d "conf.d" ]; then
        mkdir conf.d
        cp ./manifest/config/* conf.d -rpv
    fi

    echo "$config" > docker-compose.yml
}

# Fixing some nonsense with function returning
IFS=

cd "$(dirname $0)/../"

# Split our arguements into seperate sections
_command=()
for ((i=1; i<=$#; i++)); do
    if [[ "${!i}" =~ "--" || ${!i} =~ "-" ]]; then
        case ${!i} in
            --help | -h)
                _return_help
                exit
                ;;
            # Enable Services
            --enable-daemon) # Enables wings
                enable_service_node="x"
                ;;
            --enable-panel) # Enables panel
                enable_service_panel="x"
                ;;
            --enable-db) # Enables Database
                enable_service_db="x"
                ;;
            --enable-letsencrypt) # Enable Let's Encrypt
                enable_service_le="x"
                ;;
            --enable-build-options)
                enable_build_options="x"
                ;;
            # Modify Certain runtime options
            --daemon-dir)
                ((i++))
                node_directory="${!i}"
                ;;
            --daemon-docker-socket)
                ;;
            --daemon-docker-root)
                ;;
            --db-address) # Allows Database to be bound to a port;
                ((i++))
                database_ip_address="${!i}"
                ;;
        esac
    else
        _command+=("${!i}")
    fi
done

build_config
